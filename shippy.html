<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>shippy.html</title>
        <script type="text/javascript" src="../gameEngine/simpleGame.js"></script>
        <script type="text/javascript" src="../gameEngine/gameExtension.js"></script>
        <script type="text/javascript" src="shippy.js"></script>
        <script type="text/javascript">
            var scene;
            var shippy;
            var enemies;
            var explosions;
            var enemyBullets;
            var enemyTimer = new Timer();
            var bg;

            function init() {
                scene = new Scene();
                shippy = new Shippy();
                bg = new SpaceBackground(scene)
                enemyBullets = new SpriteStack(Bullet, 10);

                enemies = new SpriteStack(Enemy, 5);
                enemies.forEach(function(value, index, array) {value.launch();});

                explosions = new SpriteStack(Explosion, 6);

                shippy.setPosition(400, 300);
                scene.setBG("black");
                scene.start();
            } // end init
            
            function collide() {
                // collide ship bullets with enemies
                shippy.bullets.forEachVisible(
                    function(bullet, index, array) {
                        enemies.forEachVisible(
                            function(enemy, index2, array2) {
                                if (getDistanceBetween(bullet, enemy) < bullet.width + enemy.width) {
                                    enemy.hide();
                                    explosion = explosions.getNextHidden();
                                    explosion.setPosition(enemy.x, enemy.y);
                                    explosion.restart();
                                    bullet.hide();
                                } // end if
                            } // end function
                        );
                    } // end function
                );

                // collide enemy bullets with player
                enemyBullets.forEachVisible(
                    function(bullet, index, array) {
                        if (getDistanceBetween(bullet, shippy) < bullet.width + shippy.width) {
                            bullet.hide();
                            shippy.health -= 1;
                        } // end if
                    } // end function
                );
            } // end collide

            function checkRespawn() {
                currentEnemies = enemies.getVisibleCount();
                timeUntilRespawn = 5 / (enemies.count + 1 - currentEnemies);
                if (enemyTimer.getElapsedTime() >= timeUntilRespawn && currentEnemies < enemies.count) {
                    enemies.getNextHidden().launch();
                    enemyTimer.reset();
                } // end if
            } // end checkRespawn

            function updateHealth() {
                document.getElementById("playerHealth").innerText = "Health: " + shippy.health;
            }

            function update() {
                scene.clear();

                bg.update();
                shippy.update();
                enemies.update();
                enemyBullets.update();
                explosions.update();

                collide();
                checkRespawn();
                updateHealth();
            } // end update
        </script>
    </head>
    <body onload="init()">
        <div id="playerHealth">Health: 10</div>
    </body>
</html>