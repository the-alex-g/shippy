<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>shippy.html</title>
        <style type="text/css">
            @font-face {
                font-family: "myFont";
                src: url("./images/bonus/kenvector_future.ttf");
            }
            .canvas {
                margin:auto;
                width:50%;
            }
            .text {
                z-index: 100;
                color:aliceblue;
                background-color: black;
                position: relative;
                font-family: "myFont";
            }
            .button {
                font-family: "myFont";
                font-size: large;
            }
            #playerHealth {
                float: left;
                margin-left: 20px;
                top:40px;
                font-size: large;
            }
            #score {
                float: right;
                margin-right: 30px;
                top:40px;
                font-size: large;
            }
            #kennyNotice {
                margin:auto;
                width:50%;
                text-align: center;
            }
            #HUD {
                margin: 0;
                position: absolute;
                top: 35%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }
        </style>
        <script type="text/javascript" src="simpleGame.js"></script>
        <script type="text/javascript" src="gameExtension.js"></script>
        <script type="text/javascript" src="shippy.js"></script>
        <script type="text/javascript">
            var scene;
            var shippy;
            var enemies;
            var explosions;
            var enemyBullets;
            var enemyTimer = new Timer();
            var bg;
            var score = 0;
            var enemyShootSound;
            var explosionSound;
            var gameMode = "start";
            var highScore = 0;

            function init() {
                scene = new Scene();
                shippy = new Shippy();
                bg = new SpaceBackground(scene)
                enemyBullets = new SpriteStack(EnemyBullet, 10);
                enemyShootSound = new Sound("sfx/laser2");
                explosionSound = new Sound("sfx/explosion");

                enemies = new SpriteStack(Enemy, 5);

                explosions = new SpriteStack(Explosion, 6);
                scene.setBG("black");
                scene.start();
            } // end init


            function startGame() {
                gameMode = "play";
                shippy.health = 5;
                shippy.setPosition(400, 300);
                shippy.setSpeed(10);
                shippy.setAngle(0);
                toggleHUD(false);
                enemyBullets.hideAll();
                shippy.bullets.hideAll();
                enemies.hideAll();
                score = 0;
            } // end startGame


            function toggleHUD(state) {
                button = document.getElementById("HUD");
                button.disabled = ! state;
                button.hidden = ! state;
            } // end toggleHUD

            
            function collide() {
                // collide ship bullets with enemies
                shippy.bullets.forEachVisible(
                    function(bullet, index, array) {
                        enemies.forEachVisible(
                            function(enemy, index2, array2) {
                                if (getDistanceBetween(bullet, enemy) < (bullet.width + enemy.width) / 2) {
                                    enemy.hit();
                                    if (enemy.visible == false) {
                                        explosions.getNextHidden().explodeAt(enemy.x, enemy.y);
                                        explosionSound.play();
                                        score += enemy.type + 1;
                                    } // end if
                                    bullet.hide();
                                } // end if
                            } // end function
                        );
                    } // end function
                );

                // collide enemy bullets with player
                enemyBullets.forEachVisible(
                    function(bullet, index, array) {
                        if (getDistanceBetween(bullet, shippy) < (bullet.width + shippy.width) / 2) {
                            bullet.hide();
                            shippy.hit();
                        } // end if
                    } // end function
                );
            } // end collide

            function checkRespawn() {
                currentEnemies = enemies.getVisibleCount();
                timeUntilRespawn = 5 / (enemies.count + 1 - currentEnemies);
                if (enemyTimer.getElapsedTime() >= timeUntilRespawn && currentEnemies < enemies.count) {
                    enemies.getNextHidden().launch();
                    enemyTimer.reset();
                } // end if
            } // end checkRespawn

            function updateLabels() {
                document.getElementById("playerHealth").innerText = "Health: " + shippy.health;
                document.getElementById("score").innerText = "Score: " + score;
            } // end updateLabels

            function update() {
                scene.clear();
                bg.update();

                if (gameMode == "play") {
                    enemies.update();
                    enemyBullets.update();
                    shippy.update();
                    explosions.update();

                    collide();
                    if (shippy.health <= 0) {
                        gameMode = "pause";
                        if (score > highScore) {
                            highScore = score;
                        }
                        document.getElementById("highScore").innerText = "High Score: " + highScore;
                        toggleHUD(true);
                    } // end if

                    checkRespawn();
                    updateLabels();
                } else if (gameMode == "pause") {
                    enemies.forEach(function(enemy, b, c) {enemy.draw();});
                    shippy.draw();
                } // end if
            } // end update
        </script>
    </head>
    <body onload="init()">
        <div id="canvas" class="canvas">
            <div id="playerHealth" class="text">Health: 5</div>
            <div id="score" class="text">Score: 0</div>
            <div id="HUD" class="text">
                <p id="highScore">High Score: 0</p>
                <button class="button" onclick="startGame()">Play</button>
            </div>
            <div id="kennyNotice" class="text">Images courtesy of Kenny</div>
        </div>
    </body>
</html>